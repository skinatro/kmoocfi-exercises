name: 'Build and Push Images'
on: push

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with: 
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build and push log-output-gen
        uses: docker/build-push-action@v6
        with:
          context: ./log_output
          file: ./log_output/Dockerfile.gen
          push: true
          tags: |
            skinatro/log-output-gen:${{ github.sha }}
            skinatro/log-output-gen:latest
      
      - name: Build and push log-output-read
        uses: docker/build-push-action@v6
        with:
          context: ./log_output
          file: ./log_output/Dockerfile.read
          push: true
          tags: |
            skinatro/log-output-read:${{ github.sha }}
            skinatro/log-output-read:latest
      
      - name: Build and push ping-pong-app
        uses: docker/build-push-action@v6
        with:
          context: ./ping_pong_app
          file: ./ping_pong_app/Dockerfile
          push: true
          tags: |
            skinatro/ping-pong-app:${{ github.sha }}
            skinatro/ping-pong-app:latest
      
      - name: Set up Kustomize
        uses: imranismail/setup-kustomize@v2
      
      - name: Update image references
        run: |
          kustomize edit set image PROJECT/IMAGE_LOG=skinatro/log-output-gen:${{ github.sha }}
          kustomize edit set image PROJECT/IMAGE_LOR=skinatro/log-output-read:${{ github.sha }}
          kustomize edit set image PROJECT/IMAGE_PPA=skinatro/ping-pong-app:${{ github.sha }}
      
      - name: Commit updated kustomization.yaml
        uses: EndBug/add-and-commit@v9
        with:
          add: 'kustomization.yaml'
          message: 'Update images to ${{ github.sha }}'
